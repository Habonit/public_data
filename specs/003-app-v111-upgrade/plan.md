# Implementation Plan: App v1.1.1 Upgrade

**Branch**: `003-app-v111-upgrade` | **Date**: 2025-12-02 | **Spec**: `/specs/003-app-v111-upgrade/spec.md`
**Input**: Feature specification from `/specs/003-app-v111-upgrade/spec.md`, `docs/v1.1.1/app_improvement_proposal.md`

## Summary

대구 공공데이터 시각화 앱 v1.1에서 v1.1.1로의 업그레이드. 핵심 개선 사항:
1. **Tool Calling 도입**: 15개 분석 도구를 통한 정확한 데이터 질의응답 (기존 샘플링 방식 대체)
2. **안정성 개선**: ZeroDivisionError, NaN 처리 등 버그 수정
3. **성능 최적화**: 지도/차트 캐싱, itertuples 적용
4. **UX 개선**: 스트리밍 응답, 데이터셋별 대화 컨텍스트 분리

## Technical Context

**Language/Version**: Python 3.10+ (현재 환경: Python 3.12)
**Primary Dependencies**: Streamlit 1.28.0+, pandas 2.0.0+, numpy 1.24.0+, plotly 5.17.0+, folium 0.14.0+, streamlit-folium 0.15.0+, anthropic 0.39.0+
**Storage**: N/A (파일 기반, 사용자 업로드 CSV)
**Testing**: Manual testing (Streamlit 앱 실행)
**Target Platform**: Web browser (Streamlit)
**Project Type**: Single project (Streamlit application)
**Performance Goals**: 탭 전환 시 지도 재렌더링 1초 이내, 스트리밍 응답 첫 토큰 500ms 이내
**Constraints**: Tool Calling 최대 3회 iteration, API Key 필요
**Scale/Scope**: 단일 사용자 로컬 실행

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase 0 전 체크 (통과)

- [x] **I. Data-First Exploration**: Tool Calling으로 데이터 구조, 관계, 분포 탐색 강화
- [x] **II. Simplicity & Accessibility**: 기존 코드 구조 유지, 복잡한 패턴 미사용
- [x] **III. Educational Purpose**: 데이터 분석 학습 지원 강화
- [x] **IV. Streamlit-Based Visualization**: Streamlit 기반 유지
- [x] **V. Scope Discipline**: 정의된 범위 내 구현 (AI 질의응답 개선)

### Phase 1 후 재검증 (통과)

- [x] Python 3.10+ 호환성 확인
- [x] Streamlit 1.28.0+ 필수 기능 확인 (streaming, session_state)
- [x] anthropic 패키지 Tool Calling API 지원 확인
- [x] 기존 코드 구조 유지 (app.py, utils/ 모듈 구조)
- [x] 신규 utils/tools.py 파일만 추가 (단순 도구 모음)

## Project Structure

### Documentation (this feature)

```text
specs/003-app-v111-upgrade/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity definitions
├── quickstart.md        # Implementation guide
├── tasks.md             # Task list (generated by /speckit.tasks)
└── contracts/
    └── tools.json       # Tool schema definitions
```

### Source Code (repository root)

```text
app.py                   # Main Streamlit application (수정)
utils/
├── __init__.py          # Package initializer
├── chatbot.py           # AI chatbot module (대폭 수정 - Tool Calling)
├── tools.py             # 15개 분석 도구 (신규)
├── loader.py            # Data loading utilities
├── visualizer.py        # Chart/map visualization (수정 - 캐싱, 버그 수정)
└── geo.py               # Geospatial utilities
```

**Structure Decision**: 기존 프로젝트 구조 유지. `utils/tools.py`만 신규 추가.

---

## Implementation Phases

### Phase P0: 버그/에러 수정 (즉시)

| 순위 | 작업 | 파일 | 설명 |
|:-----|:-----|:-----|:-----|
| 0-1 | ZeroDivisionError 수정 | `app.py:645` | 빈 DataFrame 체크 |
| 0-2 | 빈 지도 렌더링 오류 | `visualizer.py:321` | early return 추가 |
| 0-3 | NaN 포맷팅 오류 | `chatbot.py:51` | NaN 체크 후 포맷 |

### Phase P1: 핵심 기능 (필수)

| 순위 | 작업 | 파일 | 설명 |
|:-----|:-----|:-----|:-----|
| 1-1 | 모델 목록 최신화 | `app.py` | Claude 4.5 시리즈 추가 |
| 1-2 | Tool 정의 파일 생성 | `utils/tools.py` | 15개 도구 정의 |
| 1-3 | Tool Calling 구현 | `utils/chatbot.py` | 도구 실행 로직, 반복 제어 |
| 1-4 | 데이터셋별 컨텍스트 분리 | `app.py` | 대화 이력 구조 변경 |

### Phase P2: 성능 개선

| 순위 | 작업 | 파일 | 설명 |
|:-----|:-----|:-----|:-----|
| 2-1 | 지도 객체 캐싱 | `app.py`, `visualizer.py` | session_state 캐싱 |
| 2-2 | st_folium 인터랙션 분리 | `app.py` | returned_objects=[] |
| 2-3 | iterrows → itertuples | `visualizer.py` | 마커 생성 최적화 |

### Phase P3: UX 개선

| 순위 | 작업 | 파일 | 설명 |
|:-----|:-----|:-----|:-----|
| 3-1 | 스트리밍 응답 | `app.py`, `chatbot.py` | st.write_stream 적용 |

---

## Key Implementation Details

### Tool Calling 구현 (utils/tools.py, utils/chatbot.py)

15개 분석 도구 정의:
| 도구명 | 설명 |
|:-------|:-----|
| `get_dataframe_info` | DataFrame 기본 정보 |
| `get_column_statistics` | 컬럼 통계 정보 |
| `get_missing_values` | 결측치 현황 |
| `get_value_counts` | 범주형 값 분포 |
| `filter_dataframe` | 조건 필터링 |
| `sort_dataframe` | 정렬 |
| `get_correlation` | 상관관계 분석 |
| `group_by_aggregate` | 그룹별 집계 |
| `get_unique_values` | 고유값 목록 |
| `get_date_range` | 날짜 범위 |
| `get_outliers` | 이상치 탐지 |
| `get_sample_rows` | 샘플 추출 |
| `calculate_percentile` | 백분위수 |
| `get_geo_bounds` | 지리적 범위 |
| `cross_tabulation` | 교차표 |

### 모델 업데이트 (app.py)

```python
AI_MODEL_OPTIONS = [
    {'id': 'claude-sonnet-4-5-20250929', 'name': 'Claude Sonnet 4.5', 'description': '빠른 응답, 비용 효율적 (권장)'},
    {'id': 'claude-opus-4-5-20251101', 'name': 'Claude Opus 4.5', 'description': '복잡한 분석에 적합'},
    {'id': 'claude-haiku-4-5-20250901', 'name': 'Claude Haiku 4.5', 'description': '간단한 질문에 최적'}
]
```

### Tool Calling 패턴 (utils/chatbot.py)

```python
MAX_ITERATIONS = 3

def run_tool_calling(client, model, messages, df, tools):
    for iteration in range(MAX_ITERATIONS):
        response = client.messages.create(
            model=model,
            max_tokens=4096,
            tools=tools,
            messages=messages
        )

        if response.stop_reason != "tool_use":
            return extract_text_response(response)

        # 도구 실행
        tool_uses = [b for b in response.content if b.type == "tool_use"]
        tool_results = []

        for tool_use in tool_uses:
            result = execute_tool(tool_use.name, tool_use.input, df)
            tool_results.append({
                "type": "tool_result",
                "tool_use_id": tool_use.id,
                "content": str(result)
            })

        messages.append({"role": "assistant", "content": response.content})
        messages.append({"role": "user", "content": tool_results})

    return "현재 앱이 답변할 수 없는 질문입니다."
```

### 캐싱 전략 (app.py, visualizer.py)

```python
# 지도 캐싱
cache_key = f"map_{dataset_name}_{len(df)}"
if cache_key not in st.session_state:
    st.session_state[cache_key] = create_folium_map(...)
st_folium(st.session_state[cache_key], returned_objects=[])
```

### 대화 컨텍스트 구조 (app.py)

```python
# 기존 (AS-IS)
st.session_state.chatbot = {
    'messages': []  # 단일 리스트
}

# 변경 (TO-BE)
st.session_state.chatbot = {
    'chat_history': {
        'cctv': [],
        'lights': [],
        # ... 데이터셋별 분리
    }
}
```

---

## Complexity Tracking

| 추가된 복잡성 | 정당화 |
|:-------------|:------|
| `utils/tools.py` 신규 파일 | 15개 도구를 별도 파일로 분리하여 가독성 향상 |
| Tool Calling 반복 로직 | 정확한 데이터 분석을 위한 필수 기능 |

**위반 사항**: 없음 - Constitution 원칙 준수

---

## Generated Artifacts

- `research.md`: Phase 0 리서치 결과 (Tool Calling API, 스트리밍, 캐싱)
- `data-model.md`: 엔티티 및 상태 전이 정의
- `contracts/tools.json`: 15개 도구의 JSON Schema 정의
- `quickstart.md`: 구현 가이드 및 테스트 체크리스트

---

## Next Steps

1. `/speckit.tasks` 실행하여 tasks.md 생성
2. Phase P0 (버그 수정) 구현
3. Phase P1 (핵심 기능) 구현
4. Phase P2 (성능 개선) 구현
5. Phase P3 (UX 개선) 구현
6. 수동 테스트 수행
